name: Link Check

# Run link checks weekly and on PRs
on:
  schedule:
    - cron: '0 3 * * 0'  # Every Sunday at 3 AM UTC
  workflow_dispatch:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  link-check:
    name: Check External Links
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: true

      - name: Check links with markdown-link-check
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.mlc_config.json'
          folder-path: './'
          file-extension: '.md'

      - name: Check HTML links
        uses: lycheeverse/lychee-action@v1.8.0
        with:
          args: --verbose --no-progress './dist/**/*.html' --exclude-mail
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Create issue for broken links
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”— Broken Links Detected',
              body: `
              ## Link Check Failed
              
              The automated link check has detected broken links in the repository.
              
              ### Failed Checks
              - [ ] Markdown links
              - [ ] HTML links in built site
              
              ### Action Required
              - Review the workflow logs for specific broken links
              - Update or remove broken links
              - Ensure all external links are accessible
              - Re-run the link check after fixes
              
              ### Workflow Details
              - **Workflow**: ${context.workflow}
              - **Run ID**: ${context.runId}
              - **Date**: ${new Date().toISOString()}
              
              ---
              
              ðŸ”— This issue was created automatically by the link check workflow.
              `,
              labels: ['maintenance', 'links', 'automated']
            })

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    needs: link-check
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: true

      - name: Serve built site
        run: |
          npm install -g serve
          serve -s dist -l 3000 &
          sleep 5

      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000
          configPath: '.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true